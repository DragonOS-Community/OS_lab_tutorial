<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>实验内容 | 操作系统实验</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="Welcome!">
    
    <link rel="preload" href="/OS_lab_tutorial/assets/css/0.styles.dbcc0abd.css" as="style"><link rel="preload" href="/OS_lab_tutorial/assets/js/app.11bc9cdf.js" as="script"><link rel="preload" href="/OS_lab_tutorial/assets/js/2.3dc1b8de.js" as="script"><link rel="preload" href="/OS_lab_tutorial/assets/js/1.7f771cfb.js" as="script"><link rel="preload" href="/OS_lab_tutorial/assets/js/28.ce8973fe.js" as="script"><link rel="prefetch" href="/OS_lab_tutorial/assets/js/10.23a1f579.js"><link rel="prefetch" href="/OS_lab_tutorial/assets/js/11.c389195a.js"><link rel="prefetch" href="/OS_lab_tutorial/assets/js/12.1d996921.js"><link rel="prefetch" href="/OS_lab_tutorial/assets/js/13.4d4410c4.js"><link rel="prefetch" href="/OS_lab_tutorial/assets/js/14.37ef2a72.js"><link rel="prefetch" href="/OS_lab_tutorial/assets/js/15.5542c093.js"><link rel="prefetch" href="/OS_lab_tutorial/assets/js/16.d48fd1ce.js"><link rel="prefetch" href="/OS_lab_tutorial/assets/js/17.bd8d538c.js"><link rel="prefetch" href="/OS_lab_tutorial/assets/js/18.6d3b94c1.js"><link rel="prefetch" href="/OS_lab_tutorial/assets/js/19.eb35cfee.js"><link rel="prefetch" href="/OS_lab_tutorial/assets/js/20.c11ec329.js"><link rel="prefetch" href="/OS_lab_tutorial/assets/js/21.db1b5d88.js"><link rel="prefetch" href="/OS_lab_tutorial/assets/js/22.bc10dbcb.js"><link rel="prefetch" href="/OS_lab_tutorial/assets/js/23.da61e3a5.js"><link rel="prefetch" href="/OS_lab_tutorial/assets/js/24.df968878.js"><link rel="prefetch" href="/OS_lab_tutorial/assets/js/25.182a101f.js"><link rel="prefetch" href="/OS_lab_tutorial/assets/js/26.abaed860.js"><link rel="prefetch" href="/OS_lab_tutorial/assets/js/27.f53ecd1d.js"><link rel="prefetch" href="/OS_lab_tutorial/assets/js/29.13038134.js"><link rel="prefetch" href="/OS_lab_tutorial/assets/js/3.5322f14a.js"><link rel="prefetch" href="/OS_lab_tutorial/assets/js/30.8831ff4f.js"><link rel="prefetch" href="/OS_lab_tutorial/assets/js/31.111c3df1.js"><link rel="prefetch" href="/OS_lab_tutorial/assets/js/32.09d2c7bf.js"><link rel="prefetch" href="/OS_lab_tutorial/assets/js/33.3ffbc094.js"><link rel="prefetch" href="/OS_lab_tutorial/assets/js/34.46f5bb23.js"><link rel="prefetch" href="/OS_lab_tutorial/assets/js/35.194738b7.js"><link rel="prefetch" href="/OS_lab_tutorial/assets/js/36.3597c59a.js"><link rel="prefetch" href="/OS_lab_tutorial/assets/js/37.437db42a.js"><link rel="prefetch" href="/OS_lab_tutorial/assets/js/38.2485c0ae.js"><link rel="prefetch" href="/OS_lab_tutorial/assets/js/39.b4d5f235.js"><link rel="prefetch" href="/OS_lab_tutorial/assets/js/4.84e1e480.js"><link rel="prefetch" href="/OS_lab_tutorial/assets/js/40.1cf48109.js"><link rel="prefetch" href="/OS_lab_tutorial/assets/js/41.88a9cd89.js"><link rel="prefetch" href="/OS_lab_tutorial/assets/js/42.517be223.js"><link rel="prefetch" href="/OS_lab_tutorial/assets/js/43.dc7c858f.js"><link rel="prefetch" href="/OS_lab_tutorial/assets/js/44.ea49cfe0.js"><link rel="prefetch" href="/OS_lab_tutorial/assets/js/45.020b5946.js"><link rel="prefetch" href="/OS_lab_tutorial/assets/js/46.9e08647b.js"><link rel="prefetch" href="/OS_lab_tutorial/assets/js/47.f9039b1a.js"><link rel="prefetch" href="/OS_lab_tutorial/assets/js/48.2f547fd0.js"><link rel="prefetch" href="/OS_lab_tutorial/assets/js/49.808c5013.js"><link rel="prefetch" href="/OS_lab_tutorial/assets/js/5.f0541060.js"><link rel="prefetch" href="/OS_lab_tutorial/assets/js/50.9a07e6b8.js"><link rel="prefetch" href="/OS_lab_tutorial/assets/js/51.9590672f.js"><link rel="prefetch" href="/OS_lab_tutorial/assets/js/52.72405151.js"><link rel="prefetch" href="/OS_lab_tutorial/assets/js/53.1531273a.js"><link rel="prefetch" href="/OS_lab_tutorial/assets/js/54.12a5d073.js"><link rel="prefetch" href="/OS_lab_tutorial/assets/js/55.25860b43.js"><link rel="prefetch" href="/OS_lab_tutorial/assets/js/56.f45c6ced.js"><link rel="prefetch" href="/OS_lab_tutorial/assets/js/57.8bc5c8a2.js"><link rel="prefetch" href="/OS_lab_tutorial/assets/js/58.4802c1c4.js"><link rel="prefetch" href="/OS_lab_tutorial/assets/js/59.ee33963c.js"><link rel="prefetch" href="/OS_lab_tutorial/assets/js/6.dfb06aa0.js"><link rel="prefetch" href="/OS_lab_tutorial/assets/js/60.4aec6da7.js"><link rel="prefetch" href="/OS_lab_tutorial/assets/js/61.f4291450.js"><link rel="prefetch" href="/OS_lab_tutorial/assets/js/62.33242384.js"><link rel="prefetch" href="/OS_lab_tutorial/assets/js/63.0baf087a.js"><link rel="prefetch" href="/OS_lab_tutorial/assets/js/64.5ef98696.js"><link rel="prefetch" href="/OS_lab_tutorial/assets/js/65.622dfe34.js"><link rel="prefetch" href="/OS_lab_tutorial/assets/js/66.69329830.js"><link rel="prefetch" href="/OS_lab_tutorial/assets/js/7.7551a9fb.js"><link rel="prefetch" href="/OS_lab_tutorial/assets/js/vendors~docsearch.5e19b665.js">
    <link rel="stylesheet" href="/OS_lab_tutorial/assets/css/0.styles.dbcc0abd.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/OS_lab_tutorial/" class="home-link router-link-active"><!----> <span class="site-name">操作系统实验</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/OS_lab_tutorial/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Linux" class="dropdown-title"><span class="title">Linux</span> <span class="arrow down"></span></button> <button type="button" aria-label="Linux" class="mobile-dropdown-title"><span class="title">Linux</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          实验教程
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/OS_lab_tutorial/Linux/Lab/Lab1.html" class="nav-link">
  实验1-熟悉类Linux系统
</a></li><li class="dropdown-subitem"><a href="/OS_lab_tutorial/Linux/Lab/Lab2.html" class="nav-link">
  实验2-进程创建与进程间通信
</a></li><li class="dropdown-subitem"><a href="/OS_lab_tutorial/Linux/Lab/Lab3/" class="nav-link">
  实验3-进程调度算法
</a></li><li class="dropdown-subitem"><a href="/OS_lab_tutorial/Linux/Lab/Lab4/" class="nav-link">
  实验4-存储管理算法
</a></li><li class="dropdown-subitem"><a href="/OS_lab_tutorial/Linux/Lab/Lab5.html" class="nav-link">
  实验5-文件管理系统
</a></li><li class="dropdown-subitem"><a href="/OS_lab_tutorial/Linux/Lab/Lab6.html" class="nav-link">
  实验6-网络编程(暂定)
</a></li></ul></li><li class="dropdown-item"><h4>
          课程练习
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/OS_lab_tutorial/Linux/Assignment/Lab1.html" class="nav-link">
  实验1-熟悉类Linux系统
</a></li><li class="dropdown-subitem"><a href="/OS_lab_tutorial/Linux/Assignment/Lab2.html" class="nav-link">
  实验2-进程创建与进程间通信
</a></li><li class="dropdown-subitem"><a href="/OS_lab_tutorial/Linux/Assignment/Lab3.html" class="nav-link">
  实验3-进程调度算法
</a></li><li class="dropdown-subitem"><a href="/OS_lab_tutorial/Linux/Assignment/Lab4.html" class="nav-link">
  实验4-存储管理算法
</a></li><li class="dropdown-subitem"><a href="/OS_lab_tutorial/Linux/Assignment/Lab5.html" class="nav-link">
  实验5-文件管理系统
</a></li><li class="dropdown-subitem"><a href="/OS_lab_tutorial/Linux/Assignment/Lab6.html" class="nav-link">
  实验6-网络编程(暂定)
</a></li></ul></li><li class="dropdown-item"><h4>
          附录
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/OS_lab_tutorial/Linux/Appendix/Lab1.html" class="nav-link">
  实验1-熟悉类Linux系统
</a></li><li class="dropdown-subitem"><a href="/OS_lab_tutorial/Linux/Appendix/Lab2.html" class="nav-link">
  实验2-进程创建与进程间通信
</a></li><li class="dropdown-subitem"><a href="/OS_lab_tutorial/Linux/Appendix/Lab3.html" class="nav-link">
  实验3-进程调度算法
</a></li><li class="dropdown-subitem"><a href="/OS_lab_tutorial/Linux/Appendix/Lab4.html" class="nav-link">
  实验4-存储管理算法
</a></li><li class="dropdown-subitem"><a href="/OS_lab_tutorial/Linux/Appendix/Lab5.html" class="nav-link">
  实验5-文件管理系统
</a></li><li class="dropdown-subitem"><a href="/OS_lab_tutorial/Linux/Appendix/Lab6.html" class="nav-link">
  实验6-网络编程(暂定)
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="DragonOS" class="dropdown-title"><span class="title">DragonOS</span> <span class="arrow down"></span></button> <button type="button" aria-label="DragonOS" class="mobile-dropdown-title"><span class="title">DragonOS</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          实验教程
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/OS_lab_tutorial/DragonOS/Lab/Lab1.html" class="nav-link">
  实验-文件系统
</a></li></ul></li><li class="dropdown-item"><h4>
          课程练习
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/OS_lab_tutorial/DragonOS/Assignment/Lab1.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  实验-文件系统
</a></li></ul></li><li class="dropdown-item"><h4>
          附录
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/OS_lab_tutorial/DragonOS/Appendix/Lab1.html" class="nav-link">
  实验-文件系统
</a></li></ul></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/OS_lab_tutorial/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Linux" class="dropdown-title"><span class="title">Linux</span> <span class="arrow down"></span></button> <button type="button" aria-label="Linux" class="mobile-dropdown-title"><span class="title">Linux</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          实验教程
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/OS_lab_tutorial/Linux/Lab/Lab1.html" class="nav-link">
  实验1-熟悉类Linux系统
</a></li><li class="dropdown-subitem"><a href="/OS_lab_tutorial/Linux/Lab/Lab2.html" class="nav-link">
  实验2-进程创建与进程间通信
</a></li><li class="dropdown-subitem"><a href="/OS_lab_tutorial/Linux/Lab/Lab3/" class="nav-link">
  实验3-进程调度算法
</a></li><li class="dropdown-subitem"><a href="/OS_lab_tutorial/Linux/Lab/Lab4/" class="nav-link">
  实验4-存储管理算法
</a></li><li class="dropdown-subitem"><a href="/OS_lab_tutorial/Linux/Lab/Lab5.html" class="nav-link">
  实验5-文件管理系统
</a></li><li class="dropdown-subitem"><a href="/OS_lab_tutorial/Linux/Lab/Lab6.html" class="nav-link">
  实验6-网络编程(暂定)
</a></li></ul></li><li class="dropdown-item"><h4>
          课程练习
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/OS_lab_tutorial/Linux/Assignment/Lab1.html" class="nav-link">
  实验1-熟悉类Linux系统
</a></li><li class="dropdown-subitem"><a href="/OS_lab_tutorial/Linux/Assignment/Lab2.html" class="nav-link">
  实验2-进程创建与进程间通信
</a></li><li class="dropdown-subitem"><a href="/OS_lab_tutorial/Linux/Assignment/Lab3.html" class="nav-link">
  实验3-进程调度算法
</a></li><li class="dropdown-subitem"><a href="/OS_lab_tutorial/Linux/Assignment/Lab4.html" class="nav-link">
  实验4-存储管理算法
</a></li><li class="dropdown-subitem"><a href="/OS_lab_tutorial/Linux/Assignment/Lab5.html" class="nav-link">
  实验5-文件管理系统
</a></li><li class="dropdown-subitem"><a href="/OS_lab_tutorial/Linux/Assignment/Lab6.html" class="nav-link">
  实验6-网络编程(暂定)
</a></li></ul></li><li class="dropdown-item"><h4>
          附录
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/OS_lab_tutorial/Linux/Appendix/Lab1.html" class="nav-link">
  实验1-熟悉类Linux系统
</a></li><li class="dropdown-subitem"><a href="/OS_lab_tutorial/Linux/Appendix/Lab2.html" class="nav-link">
  实验2-进程创建与进程间通信
</a></li><li class="dropdown-subitem"><a href="/OS_lab_tutorial/Linux/Appendix/Lab3.html" class="nav-link">
  实验3-进程调度算法
</a></li><li class="dropdown-subitem"><a href="/OS_lab_tutorial/Linux/Appendix/Lab4.html" class="nav-link">
  实验4-存储管理算法
</a></li><li class="dropdown-subitem"><a href="/OS_lab_tutorial/Linux/Appendix/Lab5.html" class="nav-link">
  实验5-文件管理系统
</a></li><li class="dropdown-subitem"><a href="/OS_lab_tutorial/Linux/Appendix/Lab6.html" class="nav-link">
  实验6-网络编程(暂定)
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="DragonOS" class="dropdown-title"><span class="title">DragonOS</span> <span class="arrow down"></span></button> <button type="button" aria-label="DragonOS" class="mobile-dropdown-title"><span class="title">DragonOS</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          实验教程
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/OS_lab_tutorial/DragonOS/Lab/Lab1.html" class="nav-link">
  实验-文件系统
</a></li></ul></li><li class="dropdown-item"><h4>
          课程练习
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/OS_lab_tutorial/DragonOS/Assignment/Lab1.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  实验-文件系统
</a></li></ul></li><li class="dropdown-item"><h4>
          附录
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/OS_lab_tutorial/DragonOS/Appendix/Lab1.html" class="nav-link">
  实验-文件系统
</a></li></ul></li></ul></div></div> <!----></nav>  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="实验内容"><a href="#实验内容" class="header-anchor">#</a> 实验内容</h2> <p>ramfs的基本功能在/kernel/src/filesystem/ramfs/mod.rs中，实现过程中请参考文件../vfs/mod.rs以及已实现函数的相关代码和注释。在实现基本的文件操作之前，需要先实现创建文件结构的辅助函数：create_with_data。其用于创建文件时，在父目录下创建带初始化数据的inode。</p> <blockquote><p>**练习1：**实现位于/kernel/src/filesystem/ramfs/mod.rs中的 create_with_data。</p></blockquote> <div class="language-rust extra-class"><pre class="language-rust"><code>    <span class="token comment">// 该函数用于在当前目录下创建一个新的inode，并传入一个简单的data字段，方便进行初始化。</span>
    <span class="token comment">// 需要判断当前inode是否是文件且是否重名，接着创建inode进行初始化。</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">create_with_data</span><span class="token punctuation">(</span>
        <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span>
        name<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">,</span>
        file_type<span class="token punctuation">:</span> <span class="token class-name">FileType</span><span class="token punctuation">,</span>
        mode<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
        data<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token keyword">dyn</span> <span class="token class-name">IndexNode</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">SystemError</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 获取当前inode</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> inode <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// LAB TODO BEGIN</span>

        <span class="token comment">// LAB TODO END</span>

        <span class="token comment">// 初始化inode的自引用的weak指针</span>
        result<span class="token number">.0</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>self_ref <span class="token operator">=</span> <span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">downgrade</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 将子inode插入父inode的B树中</span>
        inode<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token class-name">Ok</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>文件读写是文件系统的基本功能，ramfs的读写操作会将文件数据块中内容读入内存缓冲区，或将缓冲区内容写入对应文件数据块。read_at和 write_at两个函数分别用于以一定偏移量读取和写入一段长度的数据，并且返回实际的读写字节长度 （读取不能超过文件大小）</p> <blockquote><p>**练习2：**实现位于/kernel/src/filesystem/ramfs/mod.rs中的 read_at和 write_at。</p></blockquote> <div class="language-rust extra-class"><pre class="language-rust"><code>    <span class="token comment">// 该函数用于实现对文件以一定偏移量读取一段长度的数据，并且返回实际的读字节长度。</span>
    <span class="token comment">// 首先检查当前inode是否为一个文件，然后计算读文件的偏移量，最后拷贝数据（copy_from_slice）。</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">read_at</span><span class="token punctuation">(</span>
        <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span>
        offset<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
        len<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
        buf<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        _data<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">FilePrivateData</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token keyword">usize</span><span class="token punctuation">,</span> <span class="token class-name">SystemError</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> buf<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> len <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token class-name">SystemError</span><span class="token punctuation">::</span><span class="token constant">EINVAL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 加锁</span>
        <span class="token keyword">let</span> inode<span class="token punctuation">:</span> <span class="token class-name">SpinLockGuard</span><span class="token operator">&lt;</span><span class="token class-name">RamFSInode</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// LAB TODO BEGIN</span>

        <span class="token comment">// LAB TODO END</span>

        <span class="token keyword">return</span> <span class="token class-name">Ok</span><span class="token punctuation">(</span>src<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 该函数用于实现对文件以一定偏移量写一段长度的数据，并且返回实际的写字节长度。</span>
    <span class="token comment">// 首先检查当前inode是否为一个文件，如果文件大小比原来的大，那就resize这个数组，最后将数据写入（copy_from_slice）。</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">write_at</span><span class="token punctuation">(</span>
        <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span>
        offset<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
        len<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
        buf<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        _data<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">FilePrivateData</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token keyword">usize</span><span class="token punctuation">,</span> <span class="token class-name">SystemError</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> buf<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> len <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token class-name">SystemError</span><span class="token punctuation">::</span><span class="token constant">EINVAL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 加锁</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> inode<span class="token punctuation">:</span> <span class="token class-name">SpinLockGuard</span><span class="token operator">&lt;</span><span class="token class-name">RamFSInode</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 检查当前inode是否为一个文件夹，如果是的话，就返回错误</span>
        <span class="token keyword">if</span> inode<span class="token punctuation">.</span>metadata<span class="token punctuation">.</span>file_type <span class="token operator">==</span> <span class="token class-name">FileType</span><span class="token punctuation">::</span><span class="token class-name">Dir</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token class-name">SystemError</span><span class="token punctuation">::</span><span class="token constant">EISDIR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// LAB TODO BEGIN</span>

        <span class="token comment">// LAB TODO END</span>

        <span class="token keyword">return</span> <span class="token class-name">Ok</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><blockquote><p>**练习3：**模仿ramfs实现my_ramfs，并更正ramfs</p></blockquote> <p>原ramfs其实是有点小问题的，需要在my_ramfs更正后再测试，具体如下：</p> <p><strong>open和close</strong></p> <p>测试代码中打开文件调用的open函数，最终会进行系统调用，在<strong>kernel/src/syscall</strong>中，标志是<strong>SYS_OPEN</strong></p> <p><img src="/OS_lab_tutorial/docs/.vuepress/public/DragonOS/SYS_OPEN.png" alt="图片1"></p> <p>检查文件路径正确后会调用同级目录下的<strong>syscall.rs</strong>中的open函数</p> <p>测试代码中的关闭文件调用close函数也和open类似，标志为<strong>SYS_CLOSE</strong>，然后调用<strong>syscall.rs</strong>中的close函数</p> <p><img src="/OS_lab_tutorial/docs/.vuepress/public/DragonOS/SYS_CLOSE.png" alt="图片2"></p> <p>再看<strong>kernel/vfs/mod.rs</strong>的IndexNode接口中</p> <p><img src="/OS_lab_tutorial/docs/.vuepress/public/DragonOS/IndexNode_open_and_close.png" alt="图片3"></p> <p>如果文件系统没有具体实现open和close函数，就返回不支持，所以这就是出错的原因</p> <p><strong>解决方式：</strong></p> <p>在我们模仿的ramfs文件系统里，添加open和close函数的具体实现，如下：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function-definition function">open</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> _data<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">FilePrivateData</span><span class="token punctuation">,</span> _mode<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">super</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>vfs<span class="token punctuation">::</span>file<span class="token punctuation">::</span></span><span class="token class-name">FileMode</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">SystemError</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">close</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> _data<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">FilePrivateData</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">SystemError</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>fopen</strong></p> <p>测试代码中我们用到了fopen来打开文件，第二个参数的&quot;w+&quot;的含义可以在<strong>user/libs/libc/src/stdio.c</strong>文件中查看，表示读写文件，并且如果文件不存在的话就创建这个文件</p> <p>fopen的系统调用也是SYS_OPEN，但是和open的区别在于：</p> <p><img src="/OS_lab_tutorial/docs/.vuepress/public/DragonOS/SYS_OPEN_truncate.png" alt="图片4"></p> <p>fopen在满足条件的情况下会调用truncate函数，这个函数和open、close一样，也是定义在<strong>vfs/mod.rs</strong>中的IndexNode接口中，但是没有具体实现，需要文件系统自己实现，如下：
<img src="/OS_lab_tutorial/docs/.vuepress/public/DragonOS/truncate.png" alt="图片5"></p> <p><strong>解决方式：</strong></p> <p>所以需要在我们模仿的ramfs中，添加truncate的具体实现，如下：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function-definition function">truncate</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> _len<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">SystemError</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> inode <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> inode<span class="token punctuation">.</span>metadata<span class="token punctuation">.</span>file_type <span class="token operator">==</span> <span class="token class-name">FileType</span><span class="token punctuation">::</span><span class="token class-name">Dir</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token class-name">SystemError</span><span class="token punctuation">::</span><span class="token constant">EISDIR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    inode<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>_len<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="测试文件系统"><a href="#测试文件系统" class="header-anchor">#</a> 测试文件系统</h2> <p>测试我们模仿实现的my_ramfs</p> <h3 id="创建测试文件夹"><a href="#创建测试文件夹" class="header-anchor">#</a> 创建测试文件夹</h3> <p>在<strong>DragonOS/user/apps</strong>目录下新建一个文件夹<strong>my_test</strong></p> <h3 id="配置文件"><a href="#配置文件" class="header-anchor">#</a> 配置文件</h3> <h4 id="拷贝文件"><a href="#拷贝文件" class="header-anchor">#</a> 拷贝文件</h4> <p>找到<strong>DragonOS/user/apps</strong>目录下其他测试文件夹（例如：test_fstat）的两个文件：<strong>link.lds</strong> + <strong>Makefile</strong>，将这两个文件拷贝到我们新建的测试文件夹<strong>my_test</strong>中</p> <h4 id="更改makefile内容"><a href="#更改makefile内容" class="header-anchor">#</a> 更改Makefile内容</h4> <p>将<strong>Makefile</strong>中的测试目录名改回来，假设拷贝的是test_fstat目录的，则按如下修改：</p> <p><strong>test_fstat/Makefile</strong></p> <p><img src="/OS_lab_tutorial/docs/.vuepress/public/DragonOS/test_fstat_Makefile.png" alt="图片6"></p> <p><strong>my_test/Makefile</strong></p> <p><img src="/OS_lab_tutorial/docs/.vuepress/public/DragonOS/my_test_Makefile.png" alt="图片7"></p> <p>将代码里的<strong>test_fstat</strong>改为<strong>my_test</strong>（**PS:**注意区分大小写）</p> <h3 id="配置dadk"><a href="#配置dadk" class="header-anchor">#</a> 配置dadk</h3> <h4 id="拷贝文件-2"><a href="#拷贝文件-2" class="header-anchor">#</a> 拷贝文件</h4> <p>在<strong>DragonOS/user/dadk/config</strong>目录下模仿其它文件新建一个文件<strong>my_test-0.1.0.dadk</strong>（<strong>PS:<strong>这里的my_test和我们在第一步创建的测试目录名相同），然后拷贝其他文件的内容到里面，比如拷贝</strong>test_fstat-0.1.0.dadk</strong></p> <h4 id="更改dadk内容"><a href="#更改dadk内容" class="header-anchor">#</a> 更改dadk内容</h4> <p>还是和 2.2 类似，按如下修改：</p> <p><strong>test_fstat-0.1.0.dadk</strong></p> <p><img src="/OS_lab_tutorial/docs/.vuepress/public/DragonOS/test_fstat_dadk.png" alt="图片8"></p> <p><strong>my_test-0.1.0.dadk</strong></p> <p><img src="/OS_lab_tutorial/docs/.vuepress/public/DragonOS/my_test_dadk.png" alt="图片9"></p> <p>将代码里的<strong>test_fstat</strong>都改成<strong>my_test</strong></p> <h3 id="挂载文件系统"><a href="#挂载文件系统" class="header-anchor">#</a> 挂载文件系统</h3> <p>将你要测试的文件系统挂载到我们的操作系统上面</p> <p>打开<strong>DragonOS/kernel/src/filesystem/vfs/core.rs</strong>文件</p> <h4 id="导入"><a href="#导入" class="header-anchor">#</a> 导入</h4> <p>导入你自己实现的文件系统，比如我这里是模仿ramfs写了一个my_ramfs，就按如下添加：
<img src="/OS_lab_tutorial/docs/.vuepress/public/DragonOS/crate_my_ramfs.png" alt="图片10"></p> <h4 id="创建文件夹、实例并挂载"><a href="#创建文件夹、实例并挂载" class="header-anchor">#</a> 创建文件夹、实例并挂载</h4> <p>在<strong>vfs_init</strong>函数中：</p> <p>模仿其它文件系统创建当前准备测试的文件系统的文件夹，如下：</p> <p><img src="/OS_lab_tutorial/docs/.vuepress/public/DragonOS/vfs_init_mkdir.png" alt="图片11"></p> <p>紧接着在下面创建ramfs实例，并挂载，照样是模仿其它文件系统挂载，如下：</p> <p><img src="/OS_lab_tutorial/docs/.vuepress/public/DragonOS/vfs_init_mount.png" alt="图片12"></p> <h4 id="迁移伪文件系统的inode"><a href="#迁移伪文件系统的inode" class="header-anchor">#</a> 迁移伪文件系统的inode</h4> <p>在<strong>migrate_virtual_filesystem</strong>函数中：</p> <h5 id="获取inode"><a href="#获取inode" class="header-anchor">#</a> 获取inode，</h5> <p>模仿其它文件系统获取ramfs的inode，如下：</p> <p><img src="/OS_lab_tutorial/docs/.vuepress/public/DragonOS/binding.png" alt="图片13"></p> <h5 id="迁移到新的文件系统下"><a href="#迁移到新的文件系统下" class="header-anchor">#</a> 迁移到新的文件系统下</h5> <p><img src="/OS_lab_tutorial/docs/.vuepress/public/DragonOS/do_migrate.png" alt="图片14"></p> <h3 id="开始测试"><a href="#开始测试" class="header-anchor">#</a> 开始测试</h3> <p>至此，我们就可以开始测试文件系统了。</p> <p>在之前我们新建的测试文件夹<strong>DragonOS/user/apps/my_test</strong>目录下添加<strong>main.c</strong>文件，用来测试文件系统的开、关、读、写</p> <p>测试的过程中会出现一些问题，具体原因在接下来的<strong>ramfs的更正</strong>中</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdio.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//需要先创建文件夹</span>
    <span class="token keyword">int</span> check<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    check <span class="token operator">=</span> <span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token string">&quot;/ram/test_0&quot;</span><span class="token punctuation">,</span><span class="token number">0777</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>check<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Cannot create dir: /ram/test_0\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    check<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    check <span class="token operator">=</span> <span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token string">&quot;/ram/test_1&quot;</span><span class="token punctuation">,</span><span class="token number">0777</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>check<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Cannot create dir: /ram/test_1\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//测试open+close+write+read</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Test open/close/write/read\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> fd<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    fd<span class="token operator">=</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;/ram/test_0/file_0.txt&quot;</span><span class="token punctuation">,</span>O_WRONLY <span class="token operator">|</span> O_CREAT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>fd<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Open file failed!\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;File opened successfully!\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> write_ptr <span class="token operator">=</span> <span class="token string">&quot;Write str here&quot;</span><span class="token punctuation">;</span>
    <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span>write_ptr<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>write_ptr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Having written:%s\n&quot;</span><span class="token punctuation">,</span>write_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;File closed successfully!\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//测试open+close+read</span>
    fd<span class="token operator">=</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;/ram/test_0/file_0.txt&quot;</span><span class="token punctuation">,</span>O_WRONLY <span class="token operator">|</span> O_CREAT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>fd<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Open file failed!\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;File opened successfully!\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span><span class="token operator">*</span> buf<span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span>buf<span class="token punctuation">,</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Having read:%s\n&quot;</span><span class="token punctuation">,</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;File closed successfully!\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//测试fopen+fclose+fputs</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;\nTest fopen/fclose/fputs/fgets\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    FILE<span class="token operator">*</span> file <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">&quot;/ram/test_1/file_0.txt&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;w+&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>file <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Fopen file failed!\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;File opened successfully!\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> fputs_ptr <span class="token operator">=</span> <span class="token string">&quot;Fputs str here&quot;</span><span class="token punctuation">;</span>
    <span class="token function">fputs</span><span class="token punctuation">(</span>fputs_ptr<span class="token punctuation">,</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Having fput: %s\n&quot;</span><span class="token punctuation">,</span>fputs_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fclose</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;File closed successfully!\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//测试fopen+fclose+fgets</span>
    file <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">&quot;/ram/test_1/file_0.txt&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;r+&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>file<span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Fopen file failed!\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">char</span><span class="token operator">*</span> buf1<span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">fgets</span><span class="token punctuation">(</span>buf1<span class="token punctuation">,</span><span class="token number">64</span><span class="token punctuation">,</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Having got: %s\n&quot;</span><span class="token punctuation">,</span>buf1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fclose</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;File closed successfully!\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/OS_lab_tutorial/assets/js/app.11bc9cdf.js" defer></script><script src="/OS_lab_tutorial/assets/js/2.3dc1b8de.js" defer></script><script src="/OS_lab_tutorial/assets/js/1.7f771cfb.js" defer></script><script src="/OS_lab_tutorial/assets/js/28.ce8973fe.js" defer></script>
  </body>
</html>
